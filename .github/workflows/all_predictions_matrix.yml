name: All Predictions (matrix)

on:
  schedule:
    - cron: '30 3 * * 1-5'   # Mon-Fri 09:00 IST # Run on schedule (example: daily at 09:00 IST -> 03:30 UTC)  # and allow manual runs
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  issues: write

concurrency:
  group: all-predictions-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run-modes:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mode: [daily, weekly, monthly, quarterly, biquarterly, yearly]
    timeout-minutes: 40

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: python-pip-cache-${{ runner.os }}-v1-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            python-pip-cache-${{ runner.os }}-v1-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run predictor (mode = ${{ matrix.mode }})
        env:
          # GITHUB_ACTIONS is set automatically in Actions; EMAIL_* if set in repo secrets will be used
        run: python main.py --mode ${{ matrix.mode }}

      - name: Upload reports artifact for mode
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.mode }}-${{ github.run_id }}
          path: reports/

      - name: Print summary (quick)
        run: |
          echo "Uploaded reports for mode=${{ matrix.mode }} as reports-${{ matrix.mode }}-${{ github.run_id }}"
